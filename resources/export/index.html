<html>
<head>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="./bootstrap-3.3.7-dist/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet"
	href="./bootstrap-3.3.7-dist/css/bootstrap-theme.min.css">

<style>
body {
	background-color: #eee6ff;
}
</style>

<!-- Latest compiled and minified JavaScript -->
<script src="./bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

<!--Load the AJAX API-->
<script type="text/javascript"
	src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="./git.js"></script>
<script type="text/javascript" src="./git_history.js"></script>
<script type="text/javascript">
	// Load the Visualization API and the corechart package.
	google.charts.load('current', {
		'packages' : [ 'corechart' ]
	});

	// Set a callback to run when the Google Visualization API is loaded.
	google.charts.setOnLoadCallback(drawChart);

	var data = [];

	// Callback that creates and populates a data table,
	// instantiates the pie chart, passes in the data and
	// draws it.
	function drawChart() {
		drawWIPChart();
		drawCommitHistoryChart();
	}

	function drawCommitHistoryChart() {

		// Get distinct list of branches accross all dates
		var commitsByDate = {};

		var columns = [];

		var teamsMap = {};

		gitCommitHistoryData.forEach(function(commit) {

			teamsMap[commit['team']] = 1;

			var dateMap = (commitsByDate[commit['commitTime']] || {});

			dateMap[commit['team']] = (dateMap[commit['team']] || 0) + 1;

			commitsByDate[commit['commitTime']] = dateMap;

		})

		for ( var team in teamsMap) {
			columns = columns.concat([ team ]);
		}

		var tmpData = [];

		for ( var date in commitsByDate) {
			var record = [ date ];
			var dateMap = commitsByDate[date];

			columns.forEach(function(team) {
				record = record.concat([ (dateMap[team] || 0) ]);

			});
			tmpData = tmpData.concat([ record ]);
		}

		columnHeadings = [ "Date" ];
		columnHeadings = columnHeadings.concat(columns);

		var data = [ columnHeadings ];
		data = data.concat(tmpData);

		data = google.visualization.arrayToDataTable(data);

		var options = {
			width : 1000,
			height : 800,
			legend : {
				position : 'top',
				maxLines : 3
			},
			bar : {
				groupWidth : '75%'
			},
			isStacked : true,
		};

		// Instantiate and draw our chart, passing in some options.
		var historyChart = new google.visualization.ColumnChart(document
				.getElementById('history_chart_div'));
		historyChart.draw(data, options);

	}

	function drawWIPChart() {

		var columns = [ "Date" ];

		data = [];
		var tmp_data3 = [];

		// Get distinct list of branches accross all dates
		var branches = {};
		for ( var date in gitWIPData) {
			gitWIPData[date].forEach(function(edit) {
				branches[edit.branch] = 1;
			});
		}

		for ( var branch in branches) {
			columns.push(branch);
		}

		for ( var date in gitWIPData) {

			var tmp_data = {};
			gitWIPData[date].forEach(function(edit) {
				if (tmp_data[edit.branch] == null)
					tmp_data[edit.branch] = 0;
				tmp_data[edit.branch] += edit.length;
			});

			var tmp_data2 = [ date ];
			for ( var branch in branches) {
				var val = tmp_data[branch] || 0;
				tmp_data2.push(val);
			}

			tmp_data3 = tmp_data3.concat([ tmp_data2 ]);
		}

		data = data.concat([ columns ]);
		data = data.concat(tmp_data3);

		/* gitWIPData.forEach(function (edit) {
		  //columns.push(edit.branch);
		  if (tmp_data[edit.branch] == null) tmp_data[edit.branch] = 0;
		  tmp_data[edit.branch] += edit.length;
		});
		
		for(var branch in tmp_data) {
		  columns.push(branch);
		  data.push(tmp_data[branch]);
		}; */

		data = google.visualization.arrayToDataTable(data);

		var options = {
			width : 1000,
			height : 800,
			legend : {
				position : 'top',
				maxLines : 3
			},
			bar : {
				groupWidth : '75%'
			},
			isStacked : true,
		};

		// Instantiate and draw our chart, passing in some options.
		chart = new google.visualization.ColumnChart(document
				.getElementById('wip_chart_div'));
		chart.draw(data, options);

		// Every time the table fires the "select" event, it should call your
		// selectHandler() function.
		google.visualization.events.addListener(chart, 'select', selectHandler);

	}

	var chart;

	function selectHandler() {

		var selection = chart.getSelection();

		var date = data.getValue(selection[0].row, 0);
		var branch = data.getColumnLabel(selection[0].column)
		//alert('A table row was selected: ' + date + ", column: " + branch);

		drawDetailChart(date, branch);
	}

	function drawDetailChart(date, branch) {
		var gedits = gitWIPData[date];

		var file_assoc = {};
		var detail_data = [];

		gedits.forEach(function(gedit) {
			if (gedit['branch'] == branch) {
				file_assoc[gedit['path']] = (file_assoc[gedit['path']] || 0)
						+ gedit['length'];
			}
		});

		for ( var key in file_assoc) {
			var row = [ key, file_assoc[key] ];
			detail_data.push(row);
		}

		var columns = [ "path", "changes" ];
		detail_data.unshift(columns);

		detail_data = google.visualization.arrayToDataTable(detail_data);

		var options = {
			width : 1000,
			height : 1000,
			legend : {
				position : 'top',
				maxLines : 3
			},
			bar : {
				groupWidth : '75%'
			},
			isStacked : true,
		};

		document.getElementById("detail_wip_chart_panel").style.display = "block";
		
		// Instantiate and draw our chart, passing in some options.
		var detail_chart = new google.visualization.PieChart(document
				.getElementById('detail_wip_chart_div'));
		detail_chart.draw(detail_data, options);

	}
</script>
</head>

<body>

	<div class="container">
		<div class="blog-header">
			<h1>Performance Dashboard</h1>
			<p class="lead blog-description">The set of measures by which the
				software delivery team measures it's performance.</p>
		</div>

		<div class="row">

			<div class="col-sm-12 blog-main">

				<div class="panel panel-default">
					<div class="container">
						<div class="blog-header">
							<h2>Work-In-Progress (Inventory)</h2>
							<p class="lead blog-description">A measure of the amount of
								work done that hasn't been merged into master. (The lower the
								WIP the better)</p>
						</div>
					</div>
					<div id="wip_chart_div" class="panel-body"></div>
				</div>

				<!--  Detail WIP Chart  -->
				<div id="detail_wip_chart_panel" class="panel panel-default"
					style="display: none;">
					<div class="container">
						<div class="blog-header">
							<h3>Work-In-Progress (Inventory) Detail</h3>
						</div>
					</div>
					<div id="detail_wip_chart_div" class="panel-body"></div>
				</div>

				<div class="panel panel-default">
					<div class="container">
						<div class="blog-header">
							<h2>Rate of Commits (to source-code repository)</h2>
							<p class="lead blog-description">A measure of the frequency
								at which each team is committing change to the source code
								repository. (The higher the frequency the better)</p>
						</div>
					</div>
					<div id="history_chart_div" class="panel-body"></div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
